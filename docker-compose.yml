services:
  print-server:
    build: .
    container_name: docker-print-server
    restart: unless-stopped
    
    # 端口映射
    ports:
      - "8631:631"   # CUPS Web界面
      - "5000:5000" # Flask应用
    
    # 设备映射 - 允许访问USB打印机
    devices:
      - /dev/bus/usb:/dev/bus/usb
      - /dev/usb:/dev/usb
    
    # 卷映射
    volumes:
      # CUPS配置持久化
      - cups-config:/etc/cups
      # 上传文件目录
      - uploads:/app/uploads
      # 打印任务日志
      - logs:/var/log/cups
    
    # 环境变量
    environment:
      - TZ=Asia/Shanghai
      - CUPS_USER=admin
      - CUPS_PASSWORD=admin
    
    # 网络模式 - 使用host网络以更好地访问USB设备
    network_mode: host
    
    # 特权模式 - 允许访问USB设备
    privileged: true
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  cups-config:
    driver: local
  uploads:
    driver: local
  logs:
    driver: local
